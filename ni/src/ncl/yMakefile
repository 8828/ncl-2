#
#      $Id: yMakefile,v 1.52 1997-04-11 18:28:11 haley Exp $
#
#########################################################################
#									#
#			   Copyright (C)  1993				#
#	     University Corporation for Atmospheric Research		#
#			   All Rights Reserved				#
#									#
#########################################################################
#
#	File:		
#
#	Author:		Ethan Alpert
#			National Center for Atmospheric Research
#			PO 3000, Boulder, Colorado
#
#	Date:		Fri Sep 24 09:53:33 MDT 1993
#
#	Description:	
#
#	Usage:
#
#	Environment:
#
#	Files:
#
#
#	Options:



MYBIN		=	ncl
MYLIB		=	libncl
MYLIB_API	=	libnclapi
YACC		=	nyacc
LEX		=	flex


#ifdef  HPUX
ARCH_LIBS	=	-lPW
HACKOBJS	=	hphack.o
#endif

EXTRA_DEFINES = $(OS1_DEF) $(MAJOR_DEF)

API_DEFS	=	-DMAKEAPI

PROG_LIBS	=	$(HLULIBS) $(NCARGLIBS)
DEPLIBS		=	$(DEPHLULIBS) $(DEPNCARGLIBS)
EXTRA_LIBS	=	-ll $(NCDFLIBS) $(HDFLIB)
SYS_LIBS	=	$(XLIB) $(CTOFLIBS) -lm $(ARCH_LIBS)

HDRS		=	$(GEN_HDRS) $(STATIC_HDRS) $(INSTALL_HDRS)

GEN_HDRS	=	NclTypeobj.h NclTypelogical.h \
			NclTypedouble.h NclTypefloat.h \
			NclTypeint.h NclTypelong.h \
			NclTypeshort.h NclTypestring.h \
			parser.h NclTypebyte.h NclTypechar.h TypeSupport.h \
			MathFuncs.h 

STATIC_HDRS	=	AttSupport.h DataSupport.h FileSupport.h Keywords.h \
			Machine.h NclAtt.h NclData.h \
			NclFile.h NclFileInterfaces.h NclHLUObj.h NclMdInc.h \
			NclMultiDValData.h NclMultiDValHLUObjData.h \
			OpsFuncs.h OpsList.h SrcTree.h Symbol.h VarSupport.h \
			NclFileVar.h NclHLUVar.h HLUSupport.h NclCoordVar.h \
			NclType.h \
			NclMultiDValnclfileData.h NclMultiDValHLUObjData.h \
			NclOneDValCoordData.h BuiltInFuncs.h HLUFunctions.h \
			NclCallBacksI.h date.h NclGRIB.h date.h tables.h

INSTALL_HDRS	=	defs.h NclApi.h ApiRecords.h NclVar.h NclBuiltIns.h \
			NclDataDefs.h NclBuiltInSupport.h NclCallBacksI.h \
			NclFileInterfaces.h
			

API_SRCS	=	NclApi.c scanapi.c parseapi.c 
EXE_SRCS	=	Ncl.c scanner.c parser.c io.c

APISRCS		=	$(API_SRCS) $(SRCS) NclUserFuncStub.c NclUserHLUStub.c \
			NclUserFileFormStub.c
EXESRCS		=	$(EXE_SRCS) $(SRCS) NclUserFuncStub.c NclUserHLUStub.c \
			NclUserFileFormStub.c
ALLSRCS		=	$(EXESRCS)
SRCS		=	$(GEN_SRCS) $(STATIC_SRCS)

GEN_SRCS	=	NclTypedouble.c NclTypefloat.c \
			NclTypeint.c NclTypelogical.c \
			NclTypelong.c NclTypeobj.c \
			NclTypeshort.c NclTypestring.c \
			scanner.c parser.c NclTypebyte.c \
			NclTypechar.c scanapi.c parseapi.c TypeSupport.c \
			NclMultiDValData.c MathFuncs.c

STATIC_SRCS	=	AddBuiltIns.c AddFileFormats.c AddHLUObjs.c \
			AddIntrinsics.c AttSupport.c DataSupport.c Execute.c \
			FileSupport.c Formats.c InitData.c Machine.c Memory.c \
			NclAtt.c NclData.c NclFile.c NclHLUObj.c \
			NclType.c  \
			NclNetCdf.c NclVar.c OpsFuncs.c Printtoken.c SrcTree.c \
			Symbol.c Translate.c VarSupport.c NclFileVar.c \
			NclHLUVar.c HLUSupport.c NclCoordVar.c \
			NclMultiDValnclfileData.c NclMultiDValHLUObjData.c \
			NclOneDValCoordData.c BuiltInSupport.c BuiltInFuncs.c \
			HLUFunctions.c NclHDF.c NclGRIB.c date.c yywrap.c \
			GetGrids.c NclCCM.c ctoiee.c

FSRCS		=	fortranio.f gaus.f
FOBJS		=	fortranio.o gaus.o

GEN_OBJS	=	NclTypedouble.o NclTypefloat.o \
			NclTypeint.o NclTypelogical.o \
			NclTypelong.o NclTypeobj.o \
			NclTypeshort.o NclTypestring.o \
			NclTypebyte.o NclTypechar.o NclMultiDValData.o \
			TypeSupport.o MathFuncs.o

STATIC_OBJS	=	AddBuiltIns.o AddFileFormats.o AddHLUObjs.o \
			AddIntrinsics.o AttSupport.o DataSupport.o Execute.o \
			FileSupport.o Formats.o InitData.o Machine.o Memory.o \
			NclAtt.o NclData.o NclFile.o \
			NclNetCdf.o NclVar.o OpsFuncs.o Printtoken.o SrcTree.o \
			Symbol.o Translate.o VarSupport.o NclFileVar.o \
			NclHLUVar.o HLUSupport.o NclCoordVar.o NclType.o \
			NclMultiDValnclfileData.o NclMultiDValHLUObjData.o \
			NclOneDValCoordData.o BuiltInSupport.o BuiltInFuncs.o \
			HLUFunctions.o NclHDF.o NclGRIB.o date.o yywrap.o \
			GetGrids.o NclCCM.o ctoiee.o

OBJS		=	$(GEN_OBJS) $(STATIC_OBJS) $(FOBJS)

API_OBJS	=	NclApi.o scanapi.o parseapi.o ioapi.o NclHLUObjapi.o
EXE_OBJS	=	Ncl.o scanner.o parser.o io.o NclHLUObj.o

ALLOBJS		=	$(EXE_OBJS) $(OBJS)
APIOBJS		=	$(API_OBJS) $(OBJS) \
			NclUserFuncStub.o NclUserHLUStub.o NclUserFileFormStub.o
EXEOBJS		=	$(EXE_OBJS) $(OBJS)  $(HACKOBJS) \
			NclUserFuncStub.o NclUserHLUStub.o NclUserFileFormStub.o

LibraryTarget($(MYLIB),$(ALLOBJS))
LibraryTarget($(MYLIB_API),$(APIOBJS))
BuildSharedLibTarget(libNGncl,$(APIOBJS),1,0,$(HLULIB) $(NCARGCLIB) -ll $(NCDFLIBS) $(HDFLIB) $(CTOFLIBS) -lm -lc)
CProgram($(MYBIN),$(EXEOBJS),$(DEPLIBS))
BuildIncludes($(INSTALL_HDRS),ncarg/ncl,../..)
InstallTarget($(INSTALL_HDRS),$(INSTALL_INC),$(NCLINCPATH))

depend-local:: $(GEN_HDRS) $(GEN_SRCS)
DependTarget($(ALLSRCS))

CleanFilesTarget(lex.yy.c y.tab.c y.tab.h)
CleanFilesTarget($(GEN_HDRS) $(GEN_SRCS))

#
# yacc and lex dependancies
#

ioapi.o : io.c
	$(CC) -c $(API_DEFS) $(CFLAGS) io.c -o ioapi.o

NclHLUObjapi.o : NclHLUObj.c
	$(CC) -c $(API_DEFS) $(CFLAGS) NclHLUObj.c -o NclHLUObjapi.o

scanapi.c: scanner.c
	$(CP) scanner.c scanapi.c

scanapi.o: scanapi.c
	$(CC) -c $(API_DEFS) $(CFLAGS) $<

parseapi.c: parser.c
	$(CP) parser.c parseapi.c

parseapi.o: parseapi.c
	$(CC) -c $(API_DEFS) $(CFLAGS) $<

##if	defined(SUN) && (MAJOR == 4)
#scanner.c:	lex.yy.c syms_lex.sh
#	$(SHELL) syms_lex.sh
#
#parser.h:	y.tab.h syms_tab_h.sh
#	$(SHELL) syms_tab_h.sh
#
#parser.c:	y.tab.c syms_tab_c.sh
#	$(SHELL) syms_tab_c.sh
##else
scanner.c:	lex.yy.c
	$(CP) lex.yy.c scanner.c

parser.h:	y.tab.h
	$(CP) y.tab.h parser.h

parser.c:	y.tab.c
	$(CP) y.tab.c parser.c
##endif

lex.yy.c: ncl.l
	$(LEX) ncl.l

y.tab.c y.tab.h: ncl.y 
	$(YACC) -d -t ncl.y

TypeSupport.h: TypeSupport.h.sed
	@$(SHELL) type_support_h.sh

TypeSupport.c: TypeSupport.c.sed
	@$(SHELL) type_support_c.sh

NclMultiDValData.c: NclMultiDValData.c.sed MultiDValOp.c.sed NclMultiDValData.h math_funcs.sh
	@$(SHELL) multid_data_c.sh

MathFuncs.c: MathFuncs.c.sed MathFuncs.h.sed MathTemplate.c.sed MathTemplate.h.sed math_funcs.sh
	@$(SHELL) math_funcs.sh

MathFuncs.h: MathFuncs.c.sed MathFuncs.h.sed MathTemplate2.c.sed MathTemplate.c.sed MathTemplate.h.sed math_funcs.sh
	@$(SHELL) math_funcs.sh

#
# Data Object dependancies
#

#define	NclTypeRule_h(type)\
]\
NclType##type.h:	data_h.sh NclType.h.sed]\
	@$(SHELL) data_h.sh type]

#define NclTypeRule_c(type,xtra_dep)\
]\
NclType##type.c:	type##_data_c.sh op_funcs.sh NclType##type.c.specific xtra_dep]\
	@$(SHELL) type##_data_c.sh]

#define NclTypeRule(type,xtra_dep)\
NclTypeRule_h(type)\
NclTypeRule_c(type,xtra_dep)

NUM_OP_TMPL	=	TypeDivOpTemplate.c.sed \
			TypeFunctionOpTemplate.c.sed \
			TypeIsMonoFunc.c.sed \
			TypeMonoOpTemplate.c.sed \
			TypeResetMissing.c.sed \
			TypeSelectOpTemplate.c.sed \
			TypeSimpleOpTemplate.c.sed \
			TypeXorOpTemplate.c.sed \
			TypeInitClassTemplate.c.sed \
			NclType.c.sed \
			NclType.h.sed

STR_OP_TMPL	=	TypestringCompareOpTemplate.c.sed \
			TypestringSelectOpTemplate.c.sed \
			TypeInitClassTemplate.c.sed \
			NclTypestring.c.sed

FILE_OP_TMPL	=	NclMultiDValData.c.sed MultiDValOp.c.sed 


NclTypeRule(double,$(NUM_OP_TMPL))
NclTypeRule(float,$(NUM_OP_TMPL))
NclTypeRule(int,$(NUM_OP_TMPL))
NclTypeRule(long,$(NUM_OP_TMPL))
NclTypeRule(short,$(NUM_OP_TMPL))
NclTypeRule(logical,$(NUM_OP_TMPL))
NclTypeRule(string,$(STR_OP_TMPL))
NclTypeRule(obj,$(NUM_OP_TMPL))
NclTypeRule(char,$(NUM_OP_TMPL))
NclTypeRule(byte,$(NUM_OP_TMPL))

#if defined(CRAY)
BuiltInFuncs.o:  BuiltInFuncs.c
	$(CC) -g $(CFLAGS) -c BuiltInFuncs.c
#endif

#
# Data Format Dependencies
#
 
NclHDF.o: NclHDF.c
      $(CC) -c $(HDFDEFINES) $(CFLAGS) NclHDF.c

